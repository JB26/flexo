#!/bin/bash

# shellcheck disable=SC2016

function fail_and_exit() {
  printf "%-50s %s\n" "$TESTCASE" "[FAILURE]"
  exit 1
}

function print_success() {
  printf "%-50s %s\n" "$TESTCASE" "[SUCCESS]"
}

## ==============================================================================================================
TESTCASE='flexo-test-persistent-connections-s2s'
# Connections made from server-to-server (i.e., from flexo to the remote mirror) should be persistent.
## ==============================================================================================================

for i in {0..99}; do
  curl_args[i]="http://flexo-server-delay-primary:7878/test_$i"
done

echo "downloading ${curl_args[*]}"

# See the previous test case for an explanation why we choose the timeout command.
timeout 200 curl -s -f ${curl_args[*]} || fail_and_exit

print_success

## ==============================================================================================================
TESTCASE="flexo-test-mirror-selection-slow-mirror"
# If a remote mirror turns out to be very slow, flexo switches to another mirror.
## ==============================================================================================================
echo 'Server = http://flexo-server-slow-primary:7878/$repo/os/$arch' > /etc/pacman.d/mirrorlist
TIMEOUT="2"
timeout $TIMEOUT pacman -S --noconfirm --noprogressbar --downloadonly dnstracer || fail_and_exit
# Being able to download this file within the timeout is taken as proof that the fast mirror has been selected.
print_success

## ==============================================================================================================
TESTCASE='flexo-test-concurrent-download-non-blocking'
# Downloading a larger file does not stop another client from obtaining a small file quickly.
## ==============================================================================================================
echo 'Server = http://flexo-server-slow-primary:7878/$repo/os/$arch' > /etc/pacman.d/mirrorlist
# First, we start downloading a relatively large file:
timeout -v 600 curl http://flexo-server-slow-primary:7878/zero > /dev/null &
CURL_PID=$!
# Next, we download a smaller package:
SMALL_PACKAGE='realtime-privileges'
DOWNLOAD_PATH=$(pacman -Sp $SMALL_PACKAGE)

timeout -v 5 curl "$DOWNLOAD_PATH" > /dev/null || fail_and_exit
# The download of the second package should have completed before the first download.
if ps -p $CURL_PID >/dev/null; then
  print_success
else
  fail_and_exit
fi

## ==============================================================================================================
TESTCASE='flexo-test-download-large-file'
# Large files can be downloaded.
# This test case is mainly used to provoke errors due to various 2GiB or 4GiB limits. For instance,
# sendfile uses off_t as offset (see man 2 sendfile). off_t can be only 32 bit on some platforms.
## ==============================================================================================================
curl http://flexo-server-fast:7878/large > /dev/null || fail_and_exit
print_success

## ==============================================================================================================
TESTCASE='flexo-test-download-large-file-cached'
# Large files can be downloaded from the cache.
## ==============================================================================================================
curl http://flexo-server-fast:7878/large > /dev/null || fail_and_exit
print_success

## ==============================================================================================================
TESTCASE='flexo-test-download-large-file-cached-resume'
# Large files can be resumed
## ==============================================================================================================
curl --continue-at 6291456 http://flexo-server-fast:7878/large > /dev/null || fail_and_exit
print_success

## ==============================================================================================================
TESTCASE='flexo-test-download-file-malformed-xattr'
# Files can be downloaded if their extended attribute cannot be parsed to an integer
## ==============================================================================================================
CHECKSUM='752027099aeff4f4093d6155af59405f96734b62f5667a25dee7d66425763a9f'
curl http://flexo-server-fast:7878/test-malformed-xattr > /tmp/test-malformed-xattr || fail_and_exit
cat /tmp/test-malformed-xattr
echo $CHECKSUM /tmp/test-malformed-xattr | sha256sum --check - || fail_and_exit
print_success
